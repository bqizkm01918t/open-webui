name: ğŸ” è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»£ç ä¸é•œåƒ

on:
  schedule:
    - cron: '0 6 */1 * *'   # æ¯å¤© UTC æ—¶é—´ 6:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 14:00ï¼‰
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# é˜²æ­¢é‡å¤è¿è¡Œ
concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸å¹¶ä¿ç•™å·¥ä½œæµ
    runs-on: ubuntu-latest

    env:
      # ä¸Šæ¸¸ä»“åº“ä¿¡æ¯
      UPSTREAM_REPO: "https://github.com/open-webui/open-webui.git "
      UPSTREAM_BRANCH: "main"

      # å½“å‰ä»“åº“ï¼ˆä½ çš„ forkï¼‰
      MY_OWNER: "bqizkm01918t"
      MY_REPO: "open-webui"
      MY_BRANCH: "main"

      # Docker é•œåƒé…ç½®ï¼ˆä½¿ç”¨ GHCRï¼‰
      DOCKER_UPSTREAM_IMAGE: "ghcr.io/open-webui/open-webui:latest"
      DOCKER_MY_IMAGE: "ghcr.io/bqizkm01918t/open-webui:latest"

    steps:
      - name: ğŸªµ å¼€å§‹æ‰§è¡ŒåŒæ­¥ä»»åŠ¡
        run: |
          echo "ğŸš€ ã€å¼€å§‹ã€‘è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸é¡¹ç›®"
          echo "ğŸ“… å½“å‰æ—¶é—´ (UTC): $(date --utc)"
          echo "ğŸ“¦ ç›®æ ‡ä»“åº“: $MY_OWNER/$MY_REPO"
          echo "ğŸ”— ä¸Šæ¸¸åœ°å€: $UPSTREAM_REPO"
          echo "ğŸ‹ ä¸Šæ¸¸é•œåƒ: $DOCKER_UPSTREAM_IMAGE"
          echo "ğŸ“¤ æˆ‘çš„é•œåƒ: $DOCKER_MY_IMAGE"

      - name: ğŸ”½ æ£€å‡ºæˆ‘çš„ä»“åº“ï¼ˆå«å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: ğŸŒ è·å–ä¸Šæ¸¸æœ€æ–°æäº¤
        id: fetch_upstream
        run: |
          echo "ğŸ“¡ æ·»åŠ ä¸Šæ¸¸è¿œç¨‹æº..."
          git remote add upstream $UPSTREAM_REPO || true
          git fetch upstream

          # è®°å½•å½“å‰æœ¬åœ°æäº¤ï¼ˆç”¨äºæ¢å¤ workflowï¼‰
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ’¾ å½“å‰æœ¬åœ°æäº¤: $CURRENT_COMMIT"

          # è·å–ä¸Šæ¸¸æœ€æ–°æäº¤
          LATEST_UPSTREAM=$(git rev-parse upstream/$UPSTREAM_BRANCH)
          echo "ğŸ†• ä¸Šæ¸¸æœ€æ–°æäº¤: $LATEST_UPSTREAM"

          if [ "$LATEST_UPSTREAM" = "$CURRENT_COMMIT" ]; then
            echo "ğŸŸ¢ æœ¬åœ°å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥ã€‚"
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            exit 0
          else
            echo "ğŸ”¥ æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ›´æ–°ï¼Œå‡†å¤‡åŒæ­¥..."
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "CURRENT_COMMIT=$CURRENT_COMMIT" >> $GITHUB_ENV
            echo "NEW_COMMIT=$LATEST_UPSTREAM" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ åˆå¹¶ä¸Šæ¸¸å˜æ›´
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          echo "ğŸ“¦ æ­£åœ¨åº”ç”¨ä¸Šæ¸¸æ›´æ”¹..."
          git config user.name "Auto Sync Bot"
          git config user.email "sync@github.com"
          git rebase upstream/$UPSTREAM_BRANCH
          echo "âœ… æˆåŠŸåˆå¹¶ä¸Šæ¸¸ä»£ç "

      - name: ğŸ”‘ æ¢å¤å…³é”®æ–‡ä»¶ï¼ˆé˜²æ­¢å·¥ä½œæµå¤±æ•ˆï¼‰
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          echo "ğŸ›¡ï¸ ã€é‡è¦ã€‘æ­£åœ¨æ¢å¤è¢«è¦†ç›–çš„å·¥ä½œæµæ–‡ä»¶..."
          git checkout ${{ env.CURRENT_COMMIT }} -- .github/workflows/
          
          if [ -f ".github/workflows/sync-upstream.yml" ]; then
            echo "âœ… æˆåŠŸæ¢å¤ .github/workflows/sync-upstream.yml"
          else
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° sync-upstream.ymlï¼Œè¯·ç¡®è®¤è·¯å¾„æ­£ç¡®ä¸”æ–‡ä»¶å­˜åœ¨ã€‚"
            exit 1
          fi

      - name: ğŸ’¾ æäº¤æ›´æ”¹
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          git add .
          git status --porcelain | head -20 || true
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ + ä¿ç•™ CI å·¥ä½œæµ" || echo "æ— æ–°æ›´æ”¹éœ€æäº¤"

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°æˆ‘çš„ä»“åº“
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          echo "ğŸ“¤ æ¨é€æ›´æ–°åˆ° https://github.com/ $MY_OWNER/$MY_REPO"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/$MY_REPO.git $MY_BRANCH --force
          echo "ğŸ‰ ã€æˆåŠŸã€‘ä»£ç å·²æ¨é€å®Œæˆ"

      - name: ğŸ³ ç™»å½• GitHub Container Registry (GHCR)
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          echo "ğŸ” æ­£åœ¨ç™»å½• ghcr.io ..."
          # å¼ºåˆ¶ä½¿ç”¨ä½ çš„ç”¨æˆ·åç™»å½•
          echo ${{ secrets.PAT_TOKEN }} | docker login ghcr.io -u bqizkm01918t --password-stdin
          if [ $? -ne 0 ]; then
            echo "âŒ ç™»å½•å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š"
            echo "   1. PAT_TOKEN æ˜¯å¦è®¾ç½®äº† repo å’Œ write:packages æƒé™"
            echo "   2. Secrets ä¸­åç§°æ˜¯å¦ä¸º PAT_TOKEN"
            echo "   3. ç”¨æˆ·åæ˜¯å¦æ‹¼å†™æ­£ç¡®ï¼ˆbqizkm01918tï¼‰"
            exit 1
          fi
          echo "âœ… ç™»å½• ghcr.io æˆåŠŸ"

      - name: ğŸ–¼ï¸ æ‹‰å–å¹¶æ¨é€ Docker é•œåƒ
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–ä¸Šæ¸¸é•œåƒ: $DOCKER_UPSTREAM_IMAGE"
          docker pull $DOCKER_UPSTREAM_IMAGE
          if [ $? -ne 0 ]; then
            echo "âŒ æ‹‰å–é•œåƒå¤±è´¥ï¼å¯èƒ½åŸå› ï¼š"
            echo "   â€¢ é•œåƒä¸å­˜åœ¨æˆ–æ ‡ç­¾é”™è¯¯ï¼ˆå»ºè®®æŸ¥çœ‹ https://github.com/open-webui/open-webui/pkgs/container/open-webui ï¼‰"
            echo "   â€¢ ç½‘ç»œé—®é¢˜"
            exit 1
          fi

          echo "ğŸ·ï¸ æ­£åœ¨æ‰“æ ‡ç­¾ä¸º $DOCKER_MY_IMAGE"
          docker tag $DOCKER_UPSTREAM_IMAGE $DOCKER_MY_IMAGE

          echo "ğŸ“¤ æ­£åœ¨æ¨é€é•œåƒåˆ° $DOCKER_MY_IMAGE"
          docker push $DOCKER_MY_IMAGE
          if [ $? -ne 0 ]; then
            echo "âŒ æ¨é€é•œåƒå¤±è´¥ï¼å¯èƒ½åŸå› ï¼š"
            echo "   â€¢ PAT_TOKEN ç¼ºå°‘ write:packages æƒé™"
            echo "   â€¢ å°šæœªåˆå§‹åŒ–å®¹å™¨åŒ…ï¼Œè¯·å…ˆæ‰‹åŠ¨æ¨é€ä¸€æ¬¡æµ‹è¯•é•œåƒ"
            echo "   ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
            echo "      docker tag hello-world ghcr.io/bqizkm01918t/open-webui:test"
            echo "      docker push ghcr.io/bqizkm01918t/open-webui:test"
            exit 1
          fi

          echo "âœ… ã€æˆåŠŸã€‘Docker é•œåƒå·²åŒæ­¥è‡³ $DOCKER_MY_IMAGE"

      - name: ğŸ“ åŒæ­¥ä»»åŠ¡æ€»ç»“æŠ¥å‘Š
        run: |
          echo "ğŸ“Š =============== åŒæ­¥ä»»åŠ¡å®ŒæˆæŠ¥å‘Š ==============="
          echo "ğŸ“Œ ä»»åŠ¡çŠ¶æ€: æˆåŠŸ âœ”ï¸"
          echo "â° å®Œæˆæ—¶é—´ (UTC): $(date --utc)"
          if [ "${{ env.UPDATE_NEEDED }}" = "true" ]; then
            echo "ğŸ”„ åŠ¨ä½œ: å·²åŒæ­¥ä¸Šæ¸¸ä»£ç ä¸é•œåƒ"
            echo "ğŸ” æœ€æ–°æäº¤: ${{ env.NEW_COMMIT }}"
            echo "ğŸ‹ é•œåƒæ›´æ–°: $DOCKER_MY_IMAGE"
          else
            echo "ğŸ”„ åŠ¨ä½œ: æ— éœ€åŒæ­¥ï¼Œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi
          echo "ğŸ’¡ æç¤º: æœ¬å·¥ä½œæµå·²è‡ªæˆ‘ä¿æŠ¤ï¼Œä¸‹æ¬¡ä»å¯æ­£å¸¸è¿è¡Œ"
          echo "ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼ä¸‹æ¬¡è§ï½"
          echo "=================================================="
