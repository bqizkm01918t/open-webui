name: ğŸ” è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»£ç ä¸é•œåƒ

on:
  schedule:
    - cron: '0 6 */1 * *'
  workflow_dispatch:

concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸å¹¶ä¿ç•™å·¥ä½œæµ
    runs-on: ubuntu-latest

    env:
      UPSTREAM_REPO: "https://github.com/open-webui/open-webui.git "
      UPSTREAM_BRANCH: "main"
      MY_OWNER: "bqizkm01918t"
      MY_REPO: "open-webui"
      MY_BRANCH: "main"

      DOCKER_UPSTREAM_IMAGE: "ghcr.io/open-webui/open-webui:latest"
      DOCKER_MY_IMAGE: "ghcr.io/bqizkm01918t/open-webui:latest"

    steps:
      - name: ğŸªµ å¼€å§‹ä»»åŠ¡
        run: |
          echo "ğŸš€ å¯åŠ¨åŒæ­¥æµç¨‹ (UTC: $(date --utc))"

      - name: ğŸ” è°ƒè¯•ï¼šæ‰“å°ç¯å¢ƒå˜é‡
        run: |
          echo "ğŸ” å½“å‰ç”¨æˆ·: $MY_OWNER"
          echo "ğŸ“¦ ä»“åº“: $MY_REPO"
          echo "ğŸ”— ä¸Šæ¸¸: $UPSTREAM_REPO"
          echo "ğŸ³ é•œåƒ: $DOCKER_MY_IMAGE"

      - name: ğŸ”½ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: ğŸŒ è·å–ä¸Šæ¸¸æäº¤
        id: fetch_upstream
        run: |
          git config --global user.name "Auto Sync Bot"
          git config --global user.email "sync@github.com"

          git remote add upstream $UPSTREAM_REPO || true
          git fetch upstream || { echo "âŒ è·å–ä¸Šæ¸¸å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– URL"; exit 1; }

          CURRENT=$(git rev-parse HEAD)
          LATEST=$(git rev-parse upstream/$UPSTREAM_BRANCH)

          echo "ğŸ’¾ å½“å‰: $CURRENT"
          echo "ğŸ†• ä¸Šæ¸¸: $LATEST"

          if [ "$CURRENT" = "$LATEST" ]; then
            echo "ğŸŸ¢ å·²æœ€æ–°ï¼Œè·³è¿‡"
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            exit 0
          else
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "CURRENT_COMMIT=$CURRENT" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ åˆå¹¶ä¸Šæ¸¸
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          git rebase upstream/$UPSTREAM_BRANCH
          echo "âœ… åˆå¹¶å®Œæˆ"

      - name: ğŸ”‘ æ¢å¤å·¥ä½œæµæ–‡ä»¶
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          git checkout ${{ env.CURRENT_COMMIT }} -- .github/workflows/
          [ -f ".github/workflows/sync-upstream.yml" ] && echo "âœ… æ¢å¤æˆåŠŸ" || { echo "âŒ æ¢å¤å¤±è´¥"; exit 1; }

      - name: ğŸ’¾ æäº¤æ›´æ”¹
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          git add .
          git commit -m "ğŸ”„ Sync & preserve workflow" || echo "æ— å˜æ›´"

      - name: ğŸ“¤ æ¨é€æ›´æ–°ï¼ˆå¸¦è¯¦ç»†é”™è¯¯ï¼‰
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          REMOTE_URL="https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/$MY_OWNER/$MY_REPO.git"
          echo "ğŸ“¤ æ¨é€åˆ°: $REMOTE_URL"
          
          # åˆ†æ­¥æ‰§è¡Œä»¥ä¾¿å®šä½é”™è¯¯
          git remote set-url origin "$REMOTE_URL"
          git push origin $MY_BRANCH --force

          if [ $? -ne 0 ]; then
            echo "âŒ Git æ¨é€å¤±è´¥ (exit code 128)ï¼Œå¯èƒ½åŸå› ï¼š"
            echo "   1. PAT_TOKEN æ— æ•ˆæˆ–æƒé™ä¸è¶³ï¼ˆéœ€ repo + write:packagesï¼‰"
            echo "   2. ç”¨æˆ·åæ‹¼å†™é”™è¯¯ï¼ˆå½“å‰: $MY_OWNERï¼‰"
            echo "   3. ä»“åº“ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤"
            echo "   4. Actions æƒé™æœªå¼€å¯è¯»å†™"
            echo "ğŸ’¡ è¯·æ£€æŸ¥ï¼šhttps://github.com/ $MY_OWNER/$MY_REPO/settings/actions"
            exit 1
          fi
          echo "ğŸ‰ æ¨é€æˆåŠŸï¼"

      - name: ğŸ³ ç™»å½• GHCR
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          echo ${{ secrets.PAT_TOKEN }} | docker login ghcr.io -u $MY_OWNER --password-stdin
          [ $? -eq 0 ] && echo "âœ… ç™»å½•æˆåŠŸ" || { echo "âŒ ç™»å½•å¤±è´¥"; exit 1; }

      - name: ğŸ–¼ï¸ åŒæ­¥ Docker é•œåƒ
        if: ${{ env.UPDATE_NEEDED == 'true' }}
        run: |
          docker pull $DOCKER_UPSTREAM_IMAGE || { echo "âŒ æ‹‰å–å¤±è´¥"; exit 1; }
          docker tag $DOCKER_UPSTREAM_IMAGE $DOCKER_MY_IMAGE
          docker push $DOCKER_MY_IMAGE || { echo "âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ write:packages æƒé™"; exit 1; }
          echo "âœ… é•œåƒåŒæ­¥å®Œæˆ"

      - name: ğŸ“ æŠ¥å‘Šæ€»ç»“
        run: |
          echo "âœ… ä»»åŠ¡å®Œæˆï¼ä¸‹æ¬¡è§ï½"
